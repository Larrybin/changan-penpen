#!/usr/bin/env sh
# Format staged files and run typecheck before committing

pnpm exec lint-staged || exit 1

# BOM check for staged JSON/JSONC (local-only guardable via SKIP_BOM_CHECK=1)
if [ "$SKIP_BOM_CHECK" = "1" ]; then
  echo "Skipping BOM check (SKIP_BOM_CHECK=1)."
else
  STAGED_JSON=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\\.(json|jsonc)$' || true)
  if [ -n "$STAGED_JSON" ]; then
    echo "Running UTF-8 BOM check for staged JSON files..."
    while IFS= read -r f; do
      [ -z "$f" ] && continue
      node -e 'const fs=require("fs");const p=process.argv[1];try{const b=fs.readFileSync(p);if(b.length>=3&&b[0]===0xEF&&b[1]===0xBB&&b[2]===0xBF){console.error("[check-bom] UTF-8 BOM detected in "+p+". Please save as UTF-8 (no BOM) and re-stage.");process.exit(1);} }catch(e){}' "$f" || exit 1
    done <<EOF
$STAGED_JSON
EOF
  fi
fi
pnpm exec tsc --noEmit || exit 1
