#!/usr/bin/env sh
# Quality gate for raw `git push`: run `pnpm check:all` automatically unless
# the caller already went through the pnpm push helper or explicitly bypasses.
set -eu

# When pnpm push invokes git push we avoid a second run of check:all.
if [ "${PNPM_PUSH_RUNNING:-}" = "1" ]; then
  echo "[pre-push] pnpm push context detected; skipping duplicate quality gate."
  exit 0
fi

# Emergency bypass knobs (use sparingly)
if [ "${ALLOW_DIRECT_PUSH:-}" = "1" ] || [ "${HUSKY_BYPASS:-}" = "1" ] || [ "${SKIP_PRE_PUSH_CHECK_ALL:-}" = "1" ]; then
  echo "[pre-push] Bypass enabled (ALLOW_DIRECT_PUSH/HUSKY_BYPASS/SKIP_PRE_PUSH_CHECK_ALL). Proceeding with push."
  exit 0
fi

echo "[pre-push] Running 'pnpm check:all' before push..."

# Ensure pnpm exists
if ! command -v pnpm >/dev/null 2>&1; then
  echo "[pre-push] pnpm is not installed or not in PATH." >&2
  echo "           Install pnpm: https://pnpm.io/installation" >&2
  echo "           Or bypass once: ALLOW_DIRECT_PUSH=1 git push" >&2
  exit 1
fi

if ! pnpm check:all; then
  code=$?
  echo "[pre-push] 'pnpm check:all' failed (exit $code). Aborting push." >&2
  exit "$code"
fi

echo "[pre-push] Quality gate passed. Continuing with push."
exit 0
