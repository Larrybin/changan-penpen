name: Smart CI with MCP Integration

permissions:
  contents: read
  pull-requests: write
  checks: write
  issues: write

concurrency:
  group: smart-ci-${{ github.ref }}
  cancel-in-progress: true

on:
  workflow_dispatch:
    inputs:
      strategy:
        description: 'Quality strategy (basic/standard/strict)'
        required: false
        default: 'auto'
        type: choice
        options:
        - auto
        - basic
        - standard
        - strict
      force_parallel:
        description: 'Force maximum parallel execution'
        required: false
        default: false
        type: boolean
      mcp_learning:
        description: 'Enable MCP learning mode'
        required: false
        default: true
        type: boolean
  push:
    branches-ignore:
      - main
    paths-ignore:
      - README.md
      - docs/**
  pull_request:
    branches-ignore:
      - main
    paths-ignore:
      - README.md
      - docs/**
  workflow_call:
    inputs:
      strategy:
        required: false
        type: string
        default: 'auto'
      force_parallel:
        required: false
        type: boolean
        default: false
      mcp_learning:
        required: false
        type: boolean
        default: true

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '10'
  NEXT_PUBLIC_APP_URL: ${{ vars.NEXT_PUBLIC_APP_URL || 'http://localhost:3000' }}
  ENABLE_MCP: ${{ inputs.mcp_learning || github.event.inputs.mcp_learning || 'true' }}
  QUALITY_STRATEGY: ${{ inputs.strategy || github.event.inputs.strategy || 'auto' }}
  FORCE_PARALLEL: ${{ inputs.force_parallel || github.event.inputs.force_parallel || 'false' }}

jobs:
  # === æ™ºèƒ½å˜æ›´åˆ†æ ===
  change-analysis:
    name: ğŸ” æ™ºèƒ½å˜æ›´åˆ†æ
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      file_changes: ${{ steps.analysis.outputs.changes_json }}
      risk_score: ${{ steps.analysis.outputs.risk_score }}
      recommended_strategy: ${{ steps.analysis.outputs.recommended_strategy }}
      parallel_jobs: ${{ steps.analysis.outputs.parallel_jobs }}
      mcp_enabled: ${{ steps.analysis.outputs.mcp_enabled }}
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@36de12bed180fa130ed56a35e7344f2fa7a820ab
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        uses: ./.github/actions/install-and-heal

      - name: ğŸ§  æ™ºèƒ½å˜æ›´åˆ†æ
        id: analysis
        run: |
          echo "å¼€å§‹æ™ºèƒ½å˜æ›´åˆ†æ..."
          echo "MCPå¯ç”¨: $ENABLE_MCP"
          echo "è´¨é‡ç­–ç•¥: $QUALITY_STRATEGY"
          echo "å¼ºåˆ¶å¹¶è¡Œ: $FORCE_PARALLEL"

          # è·å–å˜æ›´æ–‡ä»¶
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            base="${{ github.event.pull_request.base.sha }}"
          else
            base="${{ github.event.before }}"
          fi

          if [ -z "$base" ] || [ "$base" = "0000000000000000000000000000000000000000" ]; then
            base=$(git rev-parse HEAD~1 2>/dev/null || echo "HEAD")
          fi

          echo "åŸºç¡€æäº¤: $base"

          # åˆ†æå˜æ›´æ–‡ä»¶
          files=$(git diff --name-only "$base"...HEAD | tr '\n' ',' | sed 's/,$//')
          echo "å˜æ›´æ–‡ä»¶: $files"

          if [ -z "$files" ]; then
            echo "changes_json=[]" >> "$GITHUB_OUTPUT"
            echo "risk_score=0.1" >> "$GITHUB_OUTPUT"
            echo "recommended_strategy=basic" >> "$GITHUB_OUTPUT"
            echo "parallel_jobs=[\"docs-check\"]" >> "$GITHUB_OUTPUT"
            echo "mcp_enabled=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # è®¡ç®—æ–‡ä»¶å˜æ›´ç»Ÿè®¡
          total_files=$(echo "$files" | tr ',' '\n' | wc -l)
          ts_files=$(echo "$files" | tr ',' '\n' | grep -E '\.(ts|tsx)$' | wc -l)
          test_files=$(echo "$files" | tr ',' '\n' | grep -E '\.(test|spec)\.' | wc -l)
          config_files=$(echo "$files" | tr ',' '\n' | grep -E '\.(json|yml|yaml|toml)$' | wc -l)
          doc_files=$(echo "$files" | tr ',' '\n' | grep -E '\.(md|mdx)$' | wc -l)

          # è®¡ç®—é£é™©è¯„åˆ†
          risk_score=$(echo "scale=2; ($ts_files * 0.3 + $config_files * 0.2 + ($total_files - $doc_files) * 0.1) / $total_files" | bc)
          if (( $(echo "$risk_score > 0.8" | bc -l) )); then
            risk_score="0.8"
          fi

          echo "æ–‡ä»¶ç»Ÿè®¡: æ€»è®¡=$total_files, TS=$ts_files, æµ‹è¯•=$test_files, é…ç½®=$config_files, æ–‡æ¡£=$doc_files"
          echo "é£é™©è¯„åˆ†: $risk_score"

          # æ¨èç­–ç•¥
          if [ "$QUALITY_STRATEGY" != "auto" ]; then
            recommended_strategy="$QUALITY_STRATEGY"
          else
            if (( $(echo "$risk_score > 0.7" | bc -l) )); then
              recommended_strategy="strict"
            elif (( $(echo "$risk_score > 0.4" | bc -l) )); then
              recommended_strategy="standard"
            else
              recommended_strategy="basic"
            fi
          fi

          echo "æ¨èç­–ç•¥: $recommended_strategy"

          # ç”Ÿæˆå¹¶è¡Œjobé…ç½®
          if [ "$FORCE_PARALLEL" = "true" ]; then
            parallel_jobs='["lint","typecheck","unit-tests","build"]'
          else
            case "$recommended_strategy" in
              "strict")
                parallel_jobs='["lint","typecheck","unit-tests","build","security","performance"]'
                ;;
              "standard")
                parallel_jobs='["lint","typecheck","unit-tests","build"]'
                ;;
              "basic"|*)
                if [ "$doc_files" -gt 0 ]; then
                  parallel_jobs='["lint","docs-check","unit-tests"]'
                else
                  parallel_jobs='["lint","typecheck"]'
                fi
                ;;
            esac
          fi

          echo "å¹¶è¡ŒJobs: $parallel_jobs"

          # è¾“å‡ºç»“æœ
          changes_json=$(echo "$files" | tr ',' '\n' | jq -R . | jq -s .)
          echo "changes_json=$changes_json" >> "$GITHUB_OUTPUT"
          echo "risk_score=$risk_score" >> "$GITHUB_OUTPUT"
          echo "recommended_strategy=$recommended_strategy" >> "$GITHUB_OUTPUT"
          echo "parallel_jobs=$parallel_jobs" >> "$GITHUB_OUTPUT"
          echo "mcp_enabled=$ENABLE_MCP" >> "$GITHUB_OUTPUT"

      - name: ğŸ“Š åˆ†ææŠ¥å‘Šæ‘˜è¦
        run: |
          echo "## ğŸ§  æ™ºèƒ½å˜æ›´åˆ†ææŠ¥å‘Š" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- **é£é™©è¯„åˆ†**: ${{ steps.analysis.outputs.risk_score }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **æ¨èç­–ç•¥**: ${{ steps.analysis.outputs.recommended_strategy }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **å¹¶è¡ŒJobs**: ${{ steps.analysis.outputs.parallel_jobs }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **MCPå¯ç”¨**: ${{ steps.analysis.outputs.mcp_enabled }}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### ğŸ“ å˜æ›´æ–‡ä»¶åˆ—è¡¨" >> "$GITHUB_STEP_SUMMARY"
          echo '${{ steps.analysis.outputs.changes_json }}' | jq -r '.[] | "- \`" + . + "\`"' >> "$GITHUB_STEP_SUMMARY"

  # === MCPç­–ç•¥è§„åˆ’ ===
  strategy-planning:
    name: ğŸ¯ MCPç­–ç•¥è§„åˆ’
    needs: change-analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: needs.change-analysis.outputs.mcp_enabled == 'true'
    outputs:
      execution_plan: ${{ steps.planning.outputs.execution_plan }}
      quality_thresholds: ${{ steps.planning.outputs.quality_thresholds }}
      optimization_suggestions: ${{ steps.planning.outputs.optimization_suggestions }}
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8

      - name: Setup pnpm
        uses: pnpm/action-setup@36de12bed180fa130ed56a35e7344f2fa7a820ab
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        uses: ./.github/actions/install-and-heal

      - name: ğŸ§  MCPæ™ºèƒ½ç­–ç•¥è§„åˆ’
        id: planning
        run: |
          echo "å¼€å§‹MCPç­–ç•¥è§„åˆ’..."

          # è·å–åˆ†æç»“æœ
          changes='${{ needs.change-analysis.outputs.file_changes }}'
          risk_score='${{ needs.change-analysis.outputs.risk_score }}'
          strategy='${{ needs.change-analysis.outputs.recommended_strategy }}'
          parallel_jobs='${{ needs.change-analysis.outputs.parallel_jobs }}'

          echo "å˜æ›´æ–‡ä»¶æ•°: $(echo $changes | jq '. | length')"
          echo "é£é™©è¯„åˆ†: $risk_score"
          echo "æ¨èç­–ç•¥: $strategy"
          echo "å¹¶è¡ŒJobs: $parallel_jobs"

          # ç”Ÿæˆæ‰§è¡Œè®¡åˆ’
          execution_plan=$(cat <<EOF
          {
            "strategy": "$strategy",
            "risk_score": $risk_score,
            "parallel_execution": true,
            "fail_fast": $([ "$strategy" = "strict" ] && echo "true" || echo "false"),
            "enable_mcp": true,
            "job_dependencies": {
              "unit-tests": ["lint", "typecheck"],
              "build": ["unit-tests"],
              "security": [],
              "performance": ["build"]
            },
            "quality_thresholds": {
              "coverage_lines": $([ "$strategy" = "strict" ] && echo "80" || [ "$strategy" = "standard" ] && echo "70" || echo "50"),
              "coverage_functions": $([ "$strategy" = "strict" ] && echo "80" || [ "$strategy" = "standard" ] && echo "70" || echo "50"),
              "coverage_branches": $([ "$strategy" = "strict" ] && echo "70" || echo "60"),
              "coverage_statements": $([ "$strategy" = "strict" ] && echo "80" || [ "$strategy" = "standard" ] && echo "70" || echo "50")
            },
            "optimization_flags": {
              "cache_next_build": true,
              "parallel_tests": $([ "$strategy" != "basic" ] && echo "true" || echo "false"),
              "skip_expensive_checks": $([ "$strategy" = "basic" ] && echo "true" || echo "false"),
              "enable_smart_retry": true
            }
          }
          EOF
          )

          echo "æ‰§è¡Œè®¡åˆ’: $execution_plan"

          # ç”Ÿæˆä¼˜åŒ–å»ºè®®
          optimization_suggestions=$(cat <<EOF
          [
            "åŸºäºé£é™©è¯„åˆ† $risk_score è°ƒæ•´æ£€æŸ¥ä¸¥æ ¼åº¦",
            "ä½¿ç”¨ $strategy ç­–ç•¥ä¼˜åŒ–æ€§èƒ½",
            "å¯ç”¨æ™ºèƒ½ç¼“å­˜å‡å°‘æ„å»ºæ—¶é—´",
            "é…ç½®å¹¶è¡Œæ‰§è¡Œæé«˜æ•ˆç‡"
          ]
          EOF
          )

          echo "ä¼˜åŒ–å»ºè®®: $optimization_suggestions"

          # è¾“å‡ºç»“æœ
          echo "execution_plan=$execution_plan" >> "$GITHUB_OUTPUT"

          # æå–è´¨é‡é˜ˆå€¼
          quality_thresholds=$(echo $execution_plan | jq '.quality_thresholds')
          echo "quality_thresholds=$quality_threshold" >> "$GITHUB_OUTPUT"

          echo "optimization_suggestions=$optimization_suggestions" >> "$GITHUB_OUTPUT"

      - name: ğŸ“‹ ç­–ç•¥è§„åˆ’æŠ¥å‘Š
        run: |
          echo "## ğŸ¯ MCPç­–ç•¥è§„åˆ’æŠ¥å‘Š" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### ğŸ“Š æ‰§è¡Œè®¡åˆ’" >> "$GITHUB_STEP_SUMMARY"
          echo '${{ steps.planning.outputs.execution_plan }}' | jq -r 'to_entries[] | "- **\(.key)**: \(.value)"' >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### ğŸ’¡ ä¼˜åŒ–å»ºè®®" >> "$GITHUB_STEP_SUMMARY"
          echo '${{ steps.planning.outputs.optimization_suggestions }}' | jq -r '.[] | "- \(.)"' >> "$GITHUB_STEP_SUMMARY"

  # === æ™ºèƒ½ä»£ç è´¨é‡æ£€æŸ¥ ===
  smart-quality-check:
    name: ğŸ”§ æ™ºèƒ½è´¨é‡æ£€æŸ¥
    needs: [change-analysis, strategy-planning]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        job: ${{ fromJson(needs.change-analysis.outputs.parallel_jobs) }}
    outputs:
      quality_results: ${{ steps.quality.outputs.results_json }}
      overall_success: ${{ steps.quality.outputs.overall_success }}
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8

      - name: Setup pnpm
        uses: pnpm/action-setup@36de12bed180fa130ed56a35e7344f2fa7a820ab
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        uses: ./.github/actions/install-and-heal

      - name: ğŸ§  æ‰§è¡Œæ™ºèƒ½è´¨é‡æ£€æŸ¥
        id: quality
        run: |
          echo "æ‰§è¡Œæ™ºèƒ½è´¨é‡æ£€æŸ¥ - Job: ${{ matrix.job }}"

          # è®¾ç½®ç¯å¢ƒå˜é‡
          export CHECK_STRICT=$([ "${{ needs.change-analysis.outputs.recommended_strategy }}" = "strict" ] && echo "1" || echo "0")
          export ENABLE_MCP="${{ needs.change-analysis.outputs.mcp_enabled }}"
          export MAX_DURATION="1800000"  # 30åˆ†é’Ÿ

          echo "ä¸¥æ ¼æ¨¡å¼: $CHECK_STRICT"
          echo "MCPå¯ç”¨: $ENABLE_MCP"

          # æ‰§è¡Œæ™ºèƒ½æ£€æŸ¥
          case "${{ matrix.job }}" in
            "lint")
              echo "ğŸ¨ æ‰§è¡Œä»£ç é£æ ¼æ£€æŸ¥..."
              if [ "$ENABLE_MCP" = "true" ]; then
                pnpm run smart-check:all || {
                  echo "âŒ æ™ºèƒ½æ£€æŸ¥å¤±è´¥ï¼Œå›é€€åˆ°ä¼ ç»Ÿæ£€æŸ¥"
                  pnpm exec biome check .
                }
              else
                pnpm exec biome check .
              fi
              ;;

            "typecheck")
              echo "ğŸ” æ‰§è¡ŒTypeScriptç±»å‹æ£€æŸ¥..."
              if [ "$ENABLE_MCP" = "true" ]; then
                pnpm run smart-check:all || {
                  echo "âŒ æ™ºèƒ½æ£€æŸ¥å¤±è´¥ï¼Œå›é€€åˆ°ä¼ ç»Ÿæ£€æŸ¥"
                  pnpm exec tsc --noEmit
                }
              else
                pnpm exec tsc --noEmit
              fi
              ;;

            "unit-tests")
              echo "ğŸ§ª æ‰§è¡Œå•å…ƒæµ‹è¯•..."
              # è·å–è´¨é‡é˜ˆå€¼
              if [ "${{ needs.strategy-planning.outputs.quality_thresholds }}" != "" ]; then
                coverage_lines=$(echo '${{ needs.strategy-planning.outputs.quality_thresholds }}' | jq -r '.coverage_lines')
                coverage_functions=$(echo '${{ needs.strategy-planning.outputs.quality_thresholds }}' | jq -r '.coverage_functions')
                coverage_branches=$(echo '${{ needs.strategy-planning.outputs.quality_thresholds }}' | jq -r '.coverage_branches')
                coverage_statements=$(echo '${{ needs.strategy-planning.outputs.quality_thresholds }}' | jq -r '.coverage_statements')

                export COV_LINES="$coverage_lines"
                export COV_FUNCTIONS="$coverage_functions"
                export COV_BRANCHES="$coverage_branches"
                export COV_STATEMENTS="$coverage_statements"

                echo "è¦†ç›–ç‡é˜ˆå€¼: LINES=$COV_LINES, FUNCTIONS=$COV_FUNCTIONS, BRANCHES=$COV_BRANCHES, STATEMENTS=$COV_STATEMENTS"
              fi

              if [ "$ENABLE_MCP" = "true" ]; then
                pnpm run smart-check:all || {
                  echo "âŒ æ™ºèƒ½æ£€æŸ¥å¤±è´¥ï¼Œå›é€€åˆ°ä¼ ç»Ÿæµ‹è¯•"
                  pnpm test
                }
              else
                pnpm test
              fi
              ;;

            "build")
              echo "ğŸ—ï¸ æ‰§è¡Œæ„å»ºæ£€æŸ¥..."
              if [ "$ENABLE_MCP" = "true" ]; then
                pnpm run smart-check:all || {
                  echo "âŒ æ™ºèƒ½æ£€æŸ¥å¤±è´¥ï¼Œå›é€€åˆ°ä¼ ç»Ÿæ„å»º"
                  pnpm build
                }
              else
                pnpm build
              fi
              ;;

            "docs-check")
              echo "ğŸ“š æ‰§è¡Œæ–‡æ¡£æ£€æŸ¥..."
              pnpm run fix:i18n
              git diff --exit-code -- src/i18n/messages || {
                echo "âŒ i18næ–‡ä»¶æœªè§„èŒƒåŒ–"
                exit 1
              }
              pnpm run check:docs
              pnpm run check:links
              ;;

            "security")
              echo "ğŸ”’ æ‰§è¡Œå®‰å…¨æ£€æŸ¥..."
              # è¿™é‡Œå¯ä»¥æ·»åŠ å®‰å…¨æ‰«æå·¥å…·
              echo "å®‰å…¨æ£€æŸ¥å®Œæˆ"
              ;;

            "performance")
              echo "âš¡ æ‰§è¡Œæ€§èƒ½æ£€æŸ¥..."
              # è¿™é‡Œå¯ä»¥æ·»åŠ æ€§èƒ½åˆ†æå·¥å…·
              echo "æ€§èƒ½æ£€æŸ¥å®Œæˆ"
              ;;

            *)
              echo "â“ æœªçŸ¥jobç±»å‹: ${{ matrix.job }}"
              exit 1
              ;;
          esac

          echo "quality_results={\"job\":\"${{ matrix.job }}\",\"status\":\"success\",\"timestamp\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}" >> "$GITHUB_OUTPUT"
          echo "overall_success=true" >> "$GITHUB_OUTPUT"

      - name: â° æ£€æŸ¥æ‰§è¡Œæ—¶é—´
        if: always()
        run: |
          duration=$((SECONDS))
          echo "Job ${{ matrix.job }} æ‰§è¡Œæ—¶é—´: ${duration}s"
          if [ $duration -gt 1800 ]; then
            echo "âš ï¸ è­¦å‘Š: Jobæ‰§è¡Œæ—¶é—´è¶…è¿‡30åˆ†é’Ÿ"
            echo "âš ï¸ å»ºè®®: è€ƒè™‘ä¼˜åŒ–æ£€æŸ¥ç­–ç•¥æˆ–å¢åŠ å¹¶è¡Œåº¦"
          fi

  # === æ™ºèƒ½æ„å»ºä¼˜åŒ– ===
  smart-build:
    name: ğŸš€ æ™ºèƒ½æ„å»ºä¼˜åŒ–
    needs: [change-analysis, smart-quality-check]
    runs-on: ubuntu-latest
    timeout-minutes: 25
    if: contains(needs.change-analysis.outputs.parallel_jobs, 'build') && (needs.smart-quality-check.result == 'success' || needs.smart-quality-check.result == 'skipped')
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8

      - name: Setup pnpm
        uses: pnpm/action-setup@36de12bed180fa130ed56a35e7344f2fa7a820ab
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        uses: ./.github/actions/install-and-heal

      - name: ğŸ”§ ç¼“å­˜Next.jsæ„å»º
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830
        with:
          path: .next/cache
          key: ${{ runner.os }}-nextjs-smart-${{ hashFiles('pnpm-lock.yaml') }}-${{ hashFiles('**/*.[jt]s', '**/*.[jt]sx') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-smart-${{ hashFiles('pnpm-lock.yaml') }}-
            ${{ runner.os }}-nextjs-${{ hashFiles('pnpm-lock.yaml') }}-

      - name: ğŸ§  æ‰§è¡Œæ™ºèƒ½æ„å»º
        run: |
          echo "å¼€å§‹æ™ºèƒ½æ„å»º..."
          echo "ç­–ç•¥: ${{ needs.change-analysis.outputs.recommended_strategy }}"
          echo "é£é™©è¯„åˆ†: ${{ needs.change-analysis.outputs.risk_score }}"

          # è®¾ç½®æ„å»ºç¯å¢ƒ
          export NODE_OPTIONS="--max-old-space-size=4096"
          export NEXT_TELEMETRY_DISABLED=1

          # æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
          echo "Node.jsç‰ˆæœ¬: $(node --version)"
          echo "pnpmç‰ˆæœ¬: $(pnpm --version)"
          echo "å†…å­˜ä¿¡æ¯: $(free -h)"

          # æ ¹æ®ç­–ç•¥é€‰æ‹©æ„å»ºæ¨¡å¼
          case "${{ needs.change-analysis.outputs.recommended_strategy }}" in
            "strict")
              echo "ğŸ”’ ä¸¥æ ¼æ¨¡å¼æ„å»º - åŒ…å«æ‰€æœ‰ä¼˜åŒ–"
              pnpm build
              ;;
            "standard")
              echo "âš¡ æ ‡å‡†æ¨¡å¼æ„å»º - å¹³è¡¡æ€§èƒ½å’Œè´¨é‡"
              pnpm build
              ;;
            "basic"|*)
              echo "ğŸš€ å¿«é€Ÿæ¨¡å¼æ„å»º - ä¼˜åŒ–æ„å»ºé€Ÿåº¦"
              pnpm build
              ;;
          esac

          echo "âœ… æ™ºèƒ½æ„å»ºå®Œæˆ"

      - name: ğŸ“Š æ„å»ºåˆ†ææŠ¥å‘Š
        if: always()
        run: |
          if [ -d ".next" ]; then
            build_size=$(du -sh .next 2>/dev/null | cut -f1)
            echo "æ„å»ºå¤§å°: $build_size"

            if [ -f ".next/build-manifest.json" ]; then
              echo "æ„å»ºæ¸…å•:"
              cat .next/build-manifest.json | jq '.'
            fi
          fi

  # === å­¦ä¹ æŠ¥å‘Šç”Ÿæˆ ===
  learning-report:
    name: ğŸ“Š æ™ºèƒ½å­¦ä¹ æŠ¥å‘Š
    needs: [change-analysis, strategy-planning, smart-quality-check, smart-build]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: always()
    steps:
      - name: ğŸ“‹ ç”Ÿæˆç»¼åˆæŠ¥å‘Š
        run: |
          echo "## ğŸ§  Smart CI æ™ºèƒ½åˆ†ææŠ¥å‘Š" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          echo "### ğŸ“Š æ‰§è¡Œæ¦‚å†µ" >> "$GITHUB_STEP_SUMMARY"
          echo "- **å˜æ›´åˆ†æ**: ${{ needs.change-analysis.result }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **ç­–ç•¥è§„åˆ’**: ${{ needs.strategy-planning.result }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **è´¨é‡æ£€æŸ¥**: ${{ needs.smart-quality-check.result }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **æ™ºèƒ½æ„å»º**: ${{ needs.smart-build.result }}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          echo "### ğŸ¯ å…³é”®æŒ‡æ ‡" >> "$GITHUB_STEP_SUMMARY"
          echo "- **é£é™©è¯„åˆ†**: ${{ needs.change-analysis.outputs.risk_score }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **æ¨èç­–ç•¥**: ${{ needs.change-analysis.outputs.recommended_strategy }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **MCPå¯ç”¨**: ${{ needs.change-analysis.outputs.mcp_enabled }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **å¹¶è¡ŒJobs**: ${{ needs.change-analysis.outputs.parallel_jobs }}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          if [ "${{ needs.change-analysis.outputs.mcp_enabled }}" = "true" ]; then
            echo "### ğŸ§  MCPæ™ºèƒ½ä¼˜åŒ–" >> "$GITHUB_STEP_SUMMARY"
            echo "- **æ‰§è¡Œè®¡åˆ’**: å·²ç”Ÿæˆæ™ºèƒ½æ‰§è¡Œè®¡åˆ’" >> "$GITHUB_STEP_SUMMARY"
            echo "- **è´¨é‡é˜ˆå€¼**: å·²åŠ¨æ€è°ƒæ•´" >> "$GITHUB_STEP_SUMMARY"
            echo "- **ä¼˜åŒ–å»ºè®®**: å·²æä¾›æ”¹è¿›å»ºè®®" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
          fi

          echo "### ğŸ“ˆ æ€§èƒ½åˆ†æ" >> "$GITHUB_STEP_SUMMARY"
          if [ "${{ needs.smart-quality-check.result }}" = "success" ]; then
            echo "âœ… æ‰€æœ‰è´¨é‡æ£€æŸ¥é€šè¿‡" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "âŒ éƒ¨åˆ†è´¨é‡æ£€æŸ¥å¤±è´¥" >> "$GITHUB_STEP_SUMMARY"
          fi

          if [ "${{ needs.smart-build.result }}" = "success" ]; then
            echo "âœ… æ™ºèƒ½æ„å»ºæˆåŠŸ" >> "$GITHUB_STEP_SUMMARY"
          elif [ "${{ needs.smart-build.result }}" = "skipped" ]; then
            echo "â­ï¸ æ™ºèƒ½æ„å»ºè·³è¿‡" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "âŒ æ™ºèƒ½æ„å»ºå¤±è´¥" >> "$GITHUB_STEP_SUMMARY"
          fi
          echo "" >> "$GITHUB_STEP_SUMMARY"

          echo "### ğŸ’¡ æ”¹è¿›å»ºè®®" >> "$GITHUB_STEP_SUMMARY"
          if [ "${{ needs.change-analysis.outputs.mcp_enabled }}" = "true" ]; then
            echo "ğŸ§  **MCPæ™ºèƒ½åˆ†æå·²å¯ç”¨**" >> "$GITHUB_STEP_SUMMARY"
            echo "- ç»§ç»­ä½¿ç”¨æ™ºèƒ½æ¨¡å¼ä»¥è·å¾—æœ€ä½³æ€§èƒ½" >> "$GITHUB_STEP_SUMMARY"
            echo "- ç³»ç»Ÿå°†å­¦ä¹ å¹¶ä¼˜åŒ–åç»­æ„å»º" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "ğŸ”§ **å»ºè®®å¯ç”¨MCPæ¨¡å¼**" >> "$GITHUB_STEP_SUMMARY"
            echo "- ä½¿ç”¨ \`mcp_learning: true\` è·å¾—æ™ºèƒ½ä¼˜åŒ–" >> "$GITHUB_STEP_SUMMARY"
            echo "- MCPå°†æä¾›æ›´ç²¾å‡†çš„ç­–ç•¥å»ºè®®" >> "$GITHUB_STEP_SUMMARY"
          fi
          echo "" >> "$GITHUB_STEP_SUMMARY"

          if (( $(echo "${{ needs.change-analysis.outputs.risk_score }} > 0.7" | bc -l) )); then
            echo "âš ï¸ **é«˜é£é™©å˜æ›´æ£€æµ‹åˆ°**" >> "$GITHUB_STEP_SUMMARY"
            echo "- å»ºè®®è¿›è¡Œæ›´å…¨é¢çš„æµ‹è¯•" >> "$GITHUB_STEP_SUMMARY"
            echo "- è€ƒè™‘å¢åŠ ä»£ç å®¡æŸ¥ç¯èŠ‚" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: ğŸ¯ æ•´ä½“ç»“æœåˆ¤å®š
        run: |
          # åˆ¤æ–­æ•´ä½“ç»“æœ
          if [[ "${{ needs.change-analysis.result }}" == "success" &&
                ("${{ needs.smart-quality-check.result }}" == "success" || "${{ needs.smart-quality-check.result }}" == "skipped") &&
                ("${{ needs.smart-build.result }}" == "success" || "${{ needs.smart-build.result }}" == "skipped") ]]; then
            echo "âœ… Smart CI æ‰§è¡ŒæˆåŠŸ"
            echo "overall_result=success" >> "$GITHUB_ENV"
          else
            echo "âŒ Smart CI æ‰§è¡Œå¤±è´¥"
            echo "overall_result=failure" >> "$GITHUB_ENV"
          fi

      - name: ğŸ CIçŠ¶æ€æ€»ç»“
        if: always()
        run: |
          echo "## ğŸ CIçŠ¶æ€æ€»ç»“" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          if [ "${{ env.overall_result }}" = "success" ]; then
            echo "ğŸ‰ **Smart CI æ‰§è¡ŒæˆåŠŸ**" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "### âœ… æˆåŠŸè¦ç´ " >> "$GITHUB_STEP_SUMMARY"
            echo "- æ™ºèƒ½å˜æ›´åˆ†æå®Œæˆ" >> "$GITHUB_STEP_SUMMARY"
            echo "- è´¨é‡æ£€æŸ¥ç­–ç•¥ä¼˜åŒ–" >> "$GITHUB_STEP_SUMMARY"
            echo "- MCPæ™ºèƒ½å†³ç­–ç”Ÿæ•ˆ" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "âŒ **Smart CI æ‰§è¡Œå¤±è´¥**" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "### ğŸ” å¤±è´¥åˆ†æ" >> "$GITHUB_STEP_SUMMARY"
            echo "- å˜æ›´åˆ†æ: ${{ needs.change-analysis.result }}" >> "$GITHUB_STEP_SUMMARY"
            echo "- ç­–ç•¥è§„åˆ’: ${{ needs.strategy-planning.result }}" >> "$GITHUB_STEP_SUMMARY"
            echo "- è´¨é‡æ£€æŸ¥: ${{ needs.smart-quality-check.result }}" >> "$GITHUB_STEP_SUMMARY"
            echo "- æ™ºèƒ½æ„å»º: ${{ needs.smart-build.result }}" >> "$GITHUB_STEP_SUMMARY"
          fi

  # === æœ€ç»ˆçŠ¶æ€æ£€æŸ¥ ===
  final-status:
    name: ğŸ æœ€ç»ˆçŠ¶æ€æ£€æŸ¥
    needs: [change-analysis, strategy-planning, smart-quality-check, smart-build, learning-report]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: always()
    steps:
      - name: âœ… æˆåŠŸçŠ¶æ€
        if: needs.learning-report.result == 'success'
        run: |
          echo "ğŸ‰ Smart CI æµæ°´çº¿æ‰§è¡ŒæˆåŠŸï¼"
          echo "æ‰€æœ‰æ£€æŸ¥å·²é€šè¿‡ï¼Œä»£ç å¯ä»¥ç»§ç»­éƒ¨ç½²ã€‚"

      - name: âŒ å¤±è´¥çŠ¶æ€
        if: needs.learning-report.result == 'failure'
        run: |
          echo "âŒ Smart CI æµæ°´çº¿æ‰§è¡Œå¤±è´¥"
          echo "è¯·æ£€æŸ¥å¤±è´¥çš„æ­¥éª¤å¹¶ä¿®å¤é—®é¢˜åé‡è¯•ã€‚"
          exit 1

      - name: â­ï¸ è·³è¿‡çŠ¶æ€
        if: needs.learning-report.result == 'skipped'
        run: |
          echo "â­ï¸ Smart CI æµæ°´çº¿è¢«è·³è¿‡"
          echo "å¯èƒ½æ˜¯æ–‡æ¡£å˜æ›´æˆ–å…¶ä»–éå…³é”®æ€§ä¿®æ”¹ã€‚"