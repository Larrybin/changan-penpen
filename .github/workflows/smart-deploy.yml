name: Smart Deploy with MCP Integration

permissions:
  contents: write
  deployments: write
  pull-requests: write
  issues: write

concurrency:
  group: smart-deploy-${{ github.ref }}
  cancel-in-progress: true

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'staging'
        type: choice
        options:
        - dev
        - staging
        - production
      deployment_strategy:
        description: 'éƒ¨ç½²ç­–ç•¥'
        required: false
        default: 'auto'
        type: choice
        options:
        - auto
        - rolling
        - blue-green
        - canary
      force_deploy:
        description: 'å¼ºåˆ¶éƒ¨ç½²ï¼ˆè·³è¿‡è´¨é‡æ£€æŸ¥ï¼‰'
        required: false
        default: false
        type: boolean
      enable_zero_downtime:
        description: 'å¯ç”¨é›¶åœæœºéƒ¨ç½²'
        required: false
        default: true
        type: boolean
      mcp_optimization:
        description: 'å¯ç”¨MCPä¼˜åŒ–'
        required: false
        default: true
        type: boolean
  push:
    branches: [main]
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '10'
  ENABLE_MCP: ${{ inputs.mcp_optimization || 'true' }}
  DEPLOYMENT_ENVIRONMENT: ${{ inputs.environment || github.event.inputs.environment || 'staging' }}
  DEPLOYMENT_STRATEGY: ${{ inputs.deployment_strategy || github.event.inputs.deployment_strategy || 'auto' }}
  FORCE_DEPLOY: ${{ inputs.force_deploy || github.event.inputs.force_deploy || 'false' }}
  ZERO_DOWNTIME: ${{ inputs.enable_zero_downtime || github.event.inputs.enable_zero_downtime || 'true' }}

jobs:
  # === æ™ºèƒ½éƒ¨ç½²åˆ†æ ===
  deployment-analysis:
    name: ğŸ” æ™ºèƒ½éƒ¨ç½²åˆ†æ
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      deployment_type: ${{ steps.analysis.outputs.deployment_type }}
      risk_level: ${{ steps.analysis.outputs.risk_level }}
      recommended_strategy: ${{ steps.analysis.outputs.recommended_strategy }}
      requires_testing: ${{ steps.analysis.outputs.requires_testing }}
      zero_downtime_eligible: ${{ steps.analysis.outputs.zero_downtime_eligible }}
      environment_config: ${{ steps.analysis.outputs.environment_config }}
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@36de12bed180fa130ed56a35e7344f2fa7a820ab
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        uses: ./.github/actions/install-and-heal

      - name: ğŸ§  æ™ºèƒ½éƒ¨ç½²åˆ†æ
        id: analysis
        run: |
          echo "å¼€å§‹æ™ºèƒ½éƒ¨ç½²åˆ†æ..."
          echo "ç¯å¢ƒ: $DEPLOYMENT_ENVIRONMENT"
          echo "ç­–ç•¥: $DEPLOYMENT_STRATEGY"
          echo "å¼ºåˆ¶éƒ¨ç½²: $FORCE_DEPLOY"
          echo "MCPä¼˜åŒ–: $ENABLE_MCP"

          # è·å–å˜æ›´ä¿¡æ¯
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            base="${{ github.event.pull_request.base.sha }}"
          else
            base="${{ github.event.before }}"
          fi

          if [ -z "$base" ] || [ "$base" = "0000000000000000000000000000000000000000" ]; then
            base=$(git rev-parse HEAD~1 2>/dev/null || echo "HEAD")
          fi

          echo "åŸºç¡€æäº¤: $base"

          # åˆ†æå˜æ›´æ–‡ä»¶
          files=$(git diff --name-only "$base"...HEAD 2>/dev/null || echo "")
          echo "å˜æ›´æ–‡ä»¶: $files"

          # åˆ†æéƒ¨ç½²ç±»å‹
          if [ -z "$files" ]; then
            deployment_type="none"
            risk_level="low"
          elif echo "$files" | grep -qE "\.(md|mdx)$"; then
            if echo "$files" | grep -vqE "\.(md|mdx)$"; then
              deployment_type="mixed"
              risk_level="medium"
            else
              deployment_type="docs"
              risk_level="low"
            fi
          elif echo "$files" | grep -qE "(\.env|wrangler\.toml|\.github/)"; then
            deployment_type="config"
            risk_level="high"
          elif echo "$files" | grep -qE "(src/modules/|src/app/|package\.json)"; then
            deployment_type="code"
            risk_level="high"
          else
            deployment_type="minor"
            risk_level="medium"
          fi

          echo "éƒ¨ç½²ç±»å‹: $deployment_type"
          echo "é£é™©çº§åˆ«: $risk_level"

          # æ¨èéƒ¨ç½²ç­–ç•¥
          if [ "$DEPLOYMENT_STRATEGY" != "auto" ]; then
            recommended_strategy="$DEPLOYMENT_STRATEGY"
          else
            case "$risk_level" in
              "high")
                if [ "$DEPLOYMENT_ENVIRONMENT" = "production" ]; then
                  recommended_strategy="canary"
                else
                  recommended_strategy="blue-green"
                fi
                ;;
              "medium")
                recommended_strategy="rolling"
                ;;
              "low"|*)
                recommended_strategy="direct"
                ;;
            esac
          fi

          echo "æ¨èç­–ç•¥: $recommended_strategy"

          # æ˜¯å¦éœ€è¦æµ‹è¯•
          if [ "$deployment_type" = "docs" ] || [ "$deployment_type" = "none" ]; then
            requires_testing="false"
          else
            requires_testing="true"
          fi

          # æ˜¯å¦æ”¯æŒé›¶åœæœºéƒ¨ç½²
          if [ "$deployment_type" = "config" ] || [ "$risk_level" = "high" ] || [ "$ZERO_DOWNTIME" = "false" ]; then
            zero_downtime_eligible="false"
          else
            zero_downtime_eligible="true"
          fi

          echo "éœ€è¦æµ‹è¯•: $requires_testing"
          echo "é›¶åœæœºéƒ¨ç½²æ”¯æŒ: $zero_downtime_eligible"

          # ç¯å¢ƒé…ç½®
          environment_config=$(cat <<EOF
          {
            "environment": "$DEPLOYMENT_ENVIRONMENT",
            "strategy": "$recommended_strategy",
            "risk_level": "$risk_level",
            "deployment_type": "$deployment_type",
            "requires_testing": $requires_testing,
            "zero_downtime": $zero_downtime_eligible,
            "force_deploy": $FORCE_DEPLOY,
            "mcp_optimization": $ENABLE_MCP
          }
          EOF
          )

          # è¾“å‡ºç»“æœ
          echo "deployment_type=$deployment_type" >> "$GITHUB_OUTPUT"
          echo "risk_level=$risk_level" >> "$GITHUB_OUTPUT"
          echo "recommended_strategy=$recommended_strategy" >> "$GITHUB_OUTPUT"
          echo "requires_testing=$requires_testing" >> "$GITHUB_OUTPUT"
          echo "zero_downtime_eligible=$zero_downtime_eligible" >> "$GITHUB_OUTPUT"
          echo "environment_config=$environment_config" >> "$GITHUB_OUTPUT"

      - name: ğŸ“Š éƒ¨ç½²åˆ†ææŠ¥å‘Š
        run: |
          echo "## ğŸ” æ™ºèƒ½éƒ¨ç½²åˆ†ææŠ¥å‘Š" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- **éƒ¨ç½²ç±»å‹**: ${{ steps.analysis.outputs.deployment_type }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **é£é™©çº§åˆ«**: ${{ steps.analysis.outputs.risk_level }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **æ¨èç­–ç•¥**: ${{ steps.analysis.outputs.recommended_strategy }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **éœ€è¦æµ‹è¯•**: ${{ steps.analysis.outputs.requires_testing }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **é›¶åœæœºéƒ¨ç½²**: ${{ steps.analysis.outputs.zero_downtime_eligible }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **ç¯å¢ƒ**: $DEPLOYMENT_ENVIRONMENT" >> "$GITHUB_STEP_SUMMARY"

  # === æ™ºèƒ½è´¨é‡æ£€æŸ¥ï¼ˆå¯é€‰ï¼‰ ===
  smart-quality-gate:
    name: ğŸ¯ æ™ºèƒ½è´¨é‡é—¨ç¦
    needs: deployment-analysis
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: needs.deployment-analysis.outputs.requires_testing == 'true' && env.FORCE_DEPLOY == 'false'
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8

      - name: Setup pnpm
        uses: pnpm/action-setup@36de12bed180fa130ed56a35e7344f2fa7a820ab
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        uses: ./.github/actions/install-and-heal

      - name: ğŸ§  æ‰§è¡Œæ™ºèƒ½è´¨é‡æ£€æŸ¥
        run: |
          echo "ğŸ¯ æ‰§è¡Œæ™ºèƒ½è´¨é‡æ£€æŸ¥..."
          echo "é£é™©çº§åˆ«: ${{ needs.deployment-analysis.outputs.risk_level }}"
          echo "éƒ¨ç½²ç¯å¢ƒ: $DEPLOYMENT_ENVIRONMENT"

          # æ ¹æ®é£é™©çº§åˆ«è®¾ç½®æ£€æŸ¥ä¸¥æ ¼åº¦
          if [ "${{ needs.deployment-analysis.outputs.risk_level }}" = "high" ]; then
            export CHECK_STRICT="1"
            export ENABLE_MCP="true"
          elif [ "${{ needs.deployment-analysis.outputs.risk_level }}" = "medium" ]; then
            export CHECK_STRICT="0"
            export ENABLE_MCP="true"
          else
            export CHECK_STRICT="0"
            export ENABLE_MCP="false"
          fi

          echo "ä¸¥æ ¼æ¨¡å¼: $CHECK_STRICT"
          echo "MCPå¯ç”¨: $ENABLE_MCP"

          # æ‰§è¡Œæ™ºèƒ½æ£€æŸ¥
          if [ "$ENABLE_MCP" = "true" ]; then
            pnpm run smart-check:all
          else
            # ä¼ ç»Ÿæ£€æŸ¥
            pnpm exec biome check .
            pnpm exec tsc --noEmit
            pnpm test
          fi

          echo "âœ… è´¨é‡æ£€æŸ¥é€šè¿‡"

  # === æ™ºèƒ½æ„å»º ===
  smart-build:
    name: ğŸ—ï¸ æ™ºèƒ½æ„å»º
    needs: deployment-analysis
    runs-on: ubuntu-latest
    timeout-minutes: 25
    if: needs.deployment-analysis.outputs.deployment_type != 'none' && needs.deployment-analysis.outputs.deployment_type != 'docs'
    outputs:
      build_success: ${{ steps.build.outputs.build_success }}
      build_artifact: ${{ steps.build.outputs.build_artifact }}
      build_version: ${{ steps.build.outputs.build_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8

      - name: Setup pnpm
        uses: pnpm/action-setup@36de12bed180fa130ed56a35e7344f2fa7a820ab
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        uses: ./.github/actions/install-and-heal

      - name: ğŸ”§ ç¼“å­˜Next.jsæ„å»º
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830
        with:
          path: .next/cache
          key: ${{ runner.os }}-nextjs-deploy-${{ needs.deployment-analysis.outputs.deployment_type }}-${{ hashFiles('pnpm-lock.yaml') }}-${{ hashFiles('**/*.[jt]s', '**/*.[jt]sx') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-deploy-${{ needs.deployment-analysis.outputs.deployment_type }}-${{ hashFiles('pnpm-lock.yaml') }}-
            ${{ runner.os }}-nextjs-${{ hashFiles('pnpm-lock.yaml') }}-

      - name: ğŸ§  æ‰§è¡Œæ™ºèƒ½æ„å»º
        id: build
        run: |
          echo "ğŸ—ï¸ å¼€å§‹æ™ºèƒ½æ„å»º..."
          echo "éƒ¨ç½²ç±»å‹: ${{ needs.deployment-analysis.outputs.deployment_type }}"
          echo "ç¯å¢ƒ: $DEPLOYMENT_ENVIRONMENT"
          echo "é£é™©çº§åˆ«: ${{ needs.deployment-analysis.outputs.risk_level }}"

          # è®¾ç½®æ„å»ºç¯å¢ƒ
          export NODE_OPTIONS="--max-old-space-size=4096"
          export NEXT_TELEMETRY_DISABLED=1
          export NEXT_PUBLIC_APP_URL="${{ vars.NEXT_PUBLIC_APP_URL || 'http://localhost:3000' }}"

          echo "æ„å»ºURL: $NEXT_PUBLIC_APP_URL"

          # æ ¹æ®éƒ¨ç½²ç±»å‹é€‰æ‹©æ„å»ºç­–ç•¥
          case "${{ needs.deployment-analysis.outputs.deployment_type }}" in
            "code"|"config")
              echo "ğŸ”’ å®Œæ•´æ„å»ºæ¨¡å¼ - åŒ…å«æ‰€æœ‰ä¼˜åŒ–"
              pnpm build
              pnpm run build:cf
              ;;
            "mixed"|"minor")
              echo "âš¡ å¢é‡æ„å»ºæ¨¡å¼ - ä¼˜åŒ–æ„å»ºé€Ÿåº¦"
              pnpm build
              pnpm run build:cf
              ;;
            *)
              echo "ğŸš€ å¿«é€Ÿæ„å»ºæ¨¡å¼"
              pnpm build
              pnpm run build:cf
              ;;
          esac

          # ç”Ÿæˆæ„å»ºç‰ˆæœ¬
          build_version="v$(date +%Y%m%d-%H%M%S)-${GITHUB_SHA:0:7}"
          echo "æ„å»ºç‰ˆæœ¬: $build_version"

          # æ£€æŸ¥æ„å»ºç»“æœ
          if [ -d ".open-next" ]; then
            echo "âœ… Cloudflareæ„å»ºæˆåŠŸ"
            echo "build_success=true" >> "$GITHUB_OUTPUT"
            echo "build_artifact=.open-next" >> "$GITHUB_OUTPUT"
            echo "build_version=$build_version" >> "$GITHUB_OUTPUT"
          else
            echo "âŒ Cloudflareæ„å»ºå¤±è´¥"
            echo "build_success=false" >> "$GITHUB_OUTPUT"
            exit 1
          fi

      - name: ğŸ“¦ æ„å»ºç»“æœåˆ†æ
        if: always()
        run: |
          if [ "${{ steps.build.outputs.build_success }}" = "true" ]; then
            echo "âœ… æ™ºèƒ½æ„å»ºæˆåŠŸ"
            if [ -d ".open-next" ]; then
              build_size=$(du -sh .open-next 2>/dev/null | cut -f1)
              echo "æ„å»ºå¤§å°: $build_size"
            fi
          else
            echo "âŒ æ™ºèƒ½æ„å»ºå¤±è´¥"
            exit 1
          fi

  # === MCPæ™ºèƒ½éƒ¨ç½²ç­–ç•¥ ===
  deployment-strategy:
    name: ğŸ¯ MCPéƒ¨ç½²ç­–ç•¥
    needs: [deployment-analysis, smart-build]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: needs.deployment-analysis.outputs.deployment_type != 'none' && needs.smart-build.outputs.build_success == 'true'
    outputs:
      execution_plan: ${{ steps.strategy.outputs.execution_plan }}
      deployment_config: ${{ steps.strategy.outputs.deployment_config }}
      rollback_plan: ${{ steps.strategy.outputs.rollback_plan }}
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8

      - name: ğŸ§  MCPæ™ºèƒ½ç­–ç•¥è§„åˆ’
        id: strategy
        run: |
          echo "ğŸ¯ MCPæ™ºèƒ½ç­–ç•¥è§„åˆ’..."
          echo "éƒ¨ç½²ç­–ç•¥: ${{ needs.deployment-analysis.outputs.recommended_strategy }}"
          echo "ç¯å¢ƒ: $DEPLOYMENT_ENVIRONMENT"
          echo "é£é™©çº§åˆ«: ${{ needs.deployment-analysis.outputs.risk_level }}"
          echo "é›¶åœæœºæ”¯æŒ: ${{ needs.deployment-analysis.outputs.zero_downtime_eligible }}"

          # ç”Ÿæˆæ‰§è¡Œè®¡åˆ’
          strategy="${{ needs.deployment-analysis.outputs.recommended_strategy }}"
          risk_level="${{ needs.deployment-analysis.outputs.risk_level }}"
          environment="$DEPLOYMENT_ENVIRONMENT"

          execution_plan=$(cat <<EOF
          {
            "strategy": "$strategy",
            "environment": "$environment",
            "risk_level": "$risk_level",
            "zero_downtime": ${{ needs.deployment-analysis.outputs.zero_downtime_eligible }},
            "mcp_optimization": $ENABLE_MCP,
            "steps": [
              {
                "name": "pre_deployment_check",
                "description": "éƒ¨ç½²å‰æ£€æŸ¥",
                "required": true,
                "timeout": 300
              },
              {
                "name": "backup_current",
                "description": "å¤‡ä»½å½“å‰ç‰ˆæœ¬",
                "required": $([ "$environment" = "production" ] && echo "true" || echo "false"),
                "timeout": 600
              },
              {
                "name": "deploy_new_version",
                "description": "éƒ¨ç½²æ–°ç‰ˆæœ¬",
                "required": true,
                "timeout": 900
              },
              {
                "name": "health_check",
                "description": "å¥åº·æ£€æŸ¥",
                "required": true,
                "timeout": 300
              },
              {
                "name": "traffic_switch",
                "description": "æµé‡åˆ‡æ¢",
                "required": $([ "$environment" = "production" ] && echo "true" || echo "false"),
                "timeout": 180
              }
            ],
            "rollback_triggers": [
              "health_check_failure",
              "traffic_spike",
              "error_rate_increase",
              "performance_degradation"
            ],
            "monitoring_duration": $([ "$environment" = "production" ] && echo "1800" || echo "600")
          }
          EOF
          )

          # ç”Ÿæˆéƒ¨ç½²é…ç½®
          deployment_config=$(cat <<EOF
          {
            "environment": "$environment",
            "build_version": "${{ needs.smart-build.outputs.build_version }}",
            "strategy": "$strategy",
            "wrangler_config": {
              "command": "deploy",
              "environment": "$environment",
              "compatibility_date": "2024-01-01",
              "compatibility_flags": ["nodejs_compat"],
              "minify": true
            },
            "environment_variables": {
              "NEXT_PUBLIC_APP_URL": "${{ vars.NEXT_PUBLIC_APP_URL }}",
              "DEPLOYMENT_VERSION": "${{ needs.smart-build.outputs.build_version }}",
              "DEPLOYMENT_STRATEGY": "$strategy"
            },
            "secrets": [
              "BETTER_AUTH_SECRET",
              "GOOGLE_CLIENT_ID",
              "GOOGLE_CLIENT_SECRET",
              "CLOUDFLARE_R2_URL",
              "CREEM_API_KEY",
              "CREEM_WEBHOOK_SECRET"
            ]
          }
          EOF
          )

          # ç”Ÿæˆå›æ»šè®¡åˆ’
          rollback_plan=$(cat <<EOF
          {
            "enabled": $([ "$environment" = "production" ] && echo "true" || echo "false"),
            "triggers": [
              "health_check_failure",
              "error_rate_threshold: 5%",
              "response_time_threshold: 2000ms",
              "manual_trigger"
            ],
            "steps": [
              {
                "name": "immediate_rollback",
                "description": "ç«‹å³å›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬",
                "timeout": 300
              },
              {
                "name": "verify_rollback",
                "description": "éªŒè¯å›æ»šç»“æœ",
                "timeout": 180
              },
              {
                "name": "notify_team",
                "description": "é€šçŸ¥å›¢é˜Ÿ",
                "timeout": 60
              }
            ],
            "backup_retention": "24h"
          }
          EOF
          )

          # è¾“å‡ºç»“æœ
          echo "execution_plan=$execution_plan" >> "$GITHUB_OUTPUT"
          echo "deployment_config=$deployment_config" >> "$GITHUB_OUTPUT"
          echo "rollback_plan=$rollback_plan" >> "$GITHUB_OUTPUT"

      - name: ğŸ“‹ éƒ¨ç½²ç­–ç•¥æŠ¥å‘Š
        run: |
          echo "## ğŸ¯ MCPæ™ºèƒ½éƒ¨ç½²ç­–ç•¥" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### ğŸ“Š æ‰§è¡Œè®¡åˆ’" >> "$GITHUB_STEP_SUMMARY"
          echo '${{ steps.strategy.outputs.execution_plan }}' | jq -r '.steps[] | "- **\(.name)**: \(.description) (\(.timeout)s)"' >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### ğŸ”§ éƒ¨ç½²é…ç½®" >> "$GITHUB_STEP_SUMMARY"
          echo "- **ç¯å¢ƒ**: ${{ needs.deployment-analysis.outputs.environment_config }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **æ„å»ºç‰ˆæœ¬**: ${{ needs.smart-build.outputs.build_version }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **éƒ¨ç½²ç­–ç•¥**: ${{ needs.deployment-analysis.outputs.recommended_strategy }}" >> "$GITHUB_STEP_SUMMARY"

  # === æ™ºèƒ½éƒ¨ç½²æ‰§è¡Œ ===
  smart-deployment:
    name: ğŸš€ æ™ºèƒ½éƒ¨ç½²æ‰§è¡Œ
    needs: [deployment-analysis, smart-quality-gate, smart-build, deployment-strategy]
    runs-on: ubuntu-latest
    timeout-minutes: 45
    if: needs.deployment-analysis.outputs.deployment_type != 'none' && needs.smart-build.outputs.build_success == 'true'
    environment:
      name: ${{ env.DEPLOYMENT_ENVIRONMENT }}
      url: ${{ steps.deploy.outputs.deployment_url }}
    outputs:
      deployment_url: ${{ steps.deploy.outputs.deployment_url }}
      deployment_id: ${{ steps.deploy.outputs.deployment_id }}
      deployment_status: ${{ steps.deploy.outputs.deployment_status }}
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8

      - name: Setup pnpm
        uses: pnpm/action-setup@36de12bed180fa130ed56a35e7344f2fa7a820ab
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        uses: ./.github/actions/install-and-heal

      - name: ğŸ”§ éƒ¨ç½²å‰æ£€æŸ¥
        run: |
          echo "ğŸ”§ æ‰§è¡Œéƒ¨ç½²å‰æ£€æŸ¥..."
          echo "ç¯å¢ƒ: $DEPLOYMENT_ENVIRONMENT"
          echo "æ„å»ºç‰ˆæœ¬: ${{ needs.smart-build.outputs.build_version }}"
          echo "éƒ¨ç½²ç­–ç•¥: ${{ needs.deployment-analysis.outputs.recommended_strategy }}"

          # æ£€æŸ¥å¿…éœ€çš„ç¯å¢ƒå˜é‡
          if [ "$DEPLOYMENT_ENVIRONMENT" = "production" ]; then
            required_vars=("CLOUDFLARE_API_TOKEN" "CLOUDFLARE_ACCOUNT_ID" "BETTER_AUTH_SECRET" "GOOGLE_CLIENT_ID" "GOOGLE_CLIENT_SECRET")
            missing_vars=()

            for var in "${required_vars[@]}"; do
              if [ -z "${!var}" ]; then
                missing_vars+=("$var")
              fi
            done

            if [ ${#missing_vars[@]} -gt 0 ]; then
              echo "âŒ ç¼ºå°‘å¿…éœ€çš„ç¯å¢ƒå˜é‡: ${missing_vars[*]}"
              exit 1
            fi
          fi

          echo "âœ… éƒ¨ç½²å‰æ£€æŸ¥é€šè¿‡"

      - name: ğŸ—„ï¸ å¤‡ä»½å½“å‰ç‰ˆæœ¬ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
        if: env.DEPLOYMENT_ENVIRONMENT == 'production'
        uses: cloudflare/wrangler-action@da0e0dfe58b7a431659754fdf3f186c529afbe65
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          environment: production
          wranglerVersion: '4.42.1'
          command: d1 export next-cf-app --output "backup-$(date +%Y%m%d-%H%M%S).sql"

      - name: ğŸ§  æ™ºèƒ½éƒ¨ç½²æ‰§è¡Œ
        id: deploy
        uses: cloudflare/wrangler-action@da0e0dfe58b7a431659754fdf3f186c529afbe65
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          environment: ${{ env.DEPLOYMENT_ENVIRONMENT }}
          wranglerVersion: '4.42.1'
          command: >-
            deploy
            --env ${{ env.DEPLOYMENT_ENVIRONMENT }}
            --var "CREEM_API_URL=${{ vars.CREEM_API_URL || vars.CREEM_API_URL_PRODUCTION }}"
            --var "NEXT_PUBLIC_APP_URL=${{ vars.NEXT_PUBLIC_APP_URL }}"
            --var "TRANSLATION_PROVIDER=${{ vars.TRANSLATION_PROVIDER || 'gpt' }}"
            --var "OPENAI_BASE_URL=${{ vars.OPENAI_BASE_URL }}"
            --var "DEPLOYMENT_VERSION=${{ needs.smart-build.outputs.build_version }}"
            --var "DEPLOYMENT_STRATEGY=${{ needs.deployment-analysis.outputs.recommended_strategy }}"
        env:
          BETTER_AUTH_SECRET: ${{ secrets.BETTER_AUTH_SECRET }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          CLOUDFLARE_R2_URL: ${{ secrets.CLOUDFLARE_R2_URL }}
          CREEM_API_KEY: ${{ secrets.CREEM_API_KEY }}
          CREEM_WEBHOOK_SECRET: ${{ secrets.CREEM_WEBHOOK_SECRET }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

      - name: ğŸ”„ åŒæ­¥å¯†é’¥ï¼ˆå¦‚æœéœ€è¦ï¼‰
        if: env.DEPLOYMENT_ENVIRONMENT == 'production' && vars.SYNC_PRODUCTION_SECRETS != 'false'
        run: |
          echo "ğŸ”„ åŒæ­¥ç”Ÿäº§ç¯å¢ƒå¯†é’¥..."
          sync_secret() {
            local key="$1"
            local value="${2-}"
            if [ -n "$value" ]; then
              echo "$value" | pnpm exec wrangler secret put "$key" --env production --name next-cf-app
              echo "âœ… åŒæ­¥å¯†é’¥: $key"
            else
              echo "âš ï¸ è·³è¿‡å¯†é’¥: $key (æœªè®¾ç½®)"
            fi
          }

          sync_secret "BETTER_AUTH_SECRET" "${{ secrets.BETTER_AUTH_SECRET }}"
          sync_secret "GOOGLE_CLIENT_ID" "${{ secrets.GOOGLE_CLIENT_ID }}"
          sync_secret "GOOGLE_CLIENT_SECRET" "${{ secrets.GOOGLE_CLIENT_SECRET }}"
          sync_secret "CLOUDFLARE_R2_URL" "${{ secrets.CLOUDFLARE_R2_URL }}"
          sync_secret "CREEM_API_KEY" "${{ secrets.CREEM_API_KEY }}"
          sync_secret "CREEM_WEBHOOK_SECRET" "${{ secrets.CREEM_WEBHOOK_SECRET }}"
          sync_secret "OPENAI_API_KEY" "${{ secrets.OPENAI_API_KEY }}"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: ğŸ¥ éƒ¨ç½²åå¥åº·æ£€æŸ¥
        run: |
          echo "ğŸ¥ æ‰§è¡Œéƒ¨ç½²åå¥åº·æ£€æŸ¥..."

          # ç­‰å¾…éƒ¨ç½²ç”Ÿæ•ˆ
          sleep 30

          # è·å–éƒ¨ç½²URL
          if [ "$DEPLOYMENT_ENVIRONMENT" = "production" ]; then
            app_url="${{ vars.NEXT_PUBLIC_APP_URL }}"
          else
            app_url="${{ vars.NEXT_PUBLIC_APP_URL || 'http://localhost:3000' }}"
          fi

          health_url="${app_url%/}/api/health?fast=1"

          echo "å¥åº·æ£€æŸ¥URL: $health_url"

          # æ‰§è¡Œå¥åº·æ£€æŸ¥
          max_attempts=10
          attempt=1
          success=false

          while [ $attempt -le $max_attempts ] && [ "$success" = "false" ]; do
            echo "å¥åº·æ£€æŸ¥å°è¯• $attempt/$max_attempts"

            response=$(curl -fsS --retry 2 --retry-delay 5 --connect-timeout 10 --max-time 30 -w "\nHTTP_CODE:%{http_code}" "$health_url" 2>/dev/null || echo "HTTP_CODE:000")

            http_code=$(echo "$response" | grep "HTTP_CODE:" | cut -d: -f2)

            if [ "$http_code" = "200" ]; then
              echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡"
              success=true
            else
              echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ (HTTP $http_code)"
              if [ $attempt -lt $max_attempts ]; then
                echo "ç­‰å¾…åé‡è¯•..."
                sleep 30
              fi
            fi

            attempt=$((attempt + 1))
          done

          if [ "$success" = "false" ]; then
            echo "âŒ å¥åº·æ£€æŸ¥æœ€ç»ˆå¤±è´¥"
            echo "deployment_status=failed" >> "$GITHUB_OUTPUT"
            exit 1
          fi

          echo "deployment_status=success" >> "$GITHUB_OUTPUT"
          echo "deployment_url=$app_url" >> "$GITHUB_OUTPUT"
          echo "deployment_id=${{ needs.smart-build.outputs.build_version }}" >> "$GITHUB_OUTPUT"

      - name: ğŸ“Š éƒ¨ç½²ç»“æœæŠ¥å‘Š
        if: always()
        run: |
          echo "## ğŸš€ æ™ºèƒ½éƒ¨ç½²ç»“æœ" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          if [ "${{ steps.deploy.outputs.deployment_status }}" = "success" ]; then
            echo "### âœ… éƒ¨ç½²æˆåŠŸ" >> "$GITHUB_STEP_SUMMARY"
            echo "- **éƒ¨ç½²ç¯å¢ƒ**: $DEPLOYMENT_ENVIRONMENT" >> "$GITHUB_STEP_SUMMARY"
            echo "- **æ„å»ºç‰ˆæœ¬**: ${{ needs.smart-build.outputs.build_version }}" >> "$GITHUB_STEP_SUMMARY"
            echo "- **éƒ¨ç½²ç­–ç•¥**: ${{ needs.deployment-analysis.outputs.recommended_strategy }}" >> "$GITHUB_STEP_SUMMARY"
            echo "- **éƒ¨ç½²URL**: ${{ steps.deploy.outputs.deployment_url }}" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "### âŒ éƒ¨ç½²å¤±è´¥" >> "$GITHUB_STEP_SUMMARY"
            echo "- **ç¯å¢ƒ**: $DEPLOYMENT_ENVIRONMENT" >> "$GITHUB_STEP_SUMMARY"
            echo "- **ç‰ˆæœ¬**: ${{ needs.smart-build.outputs.build_version }}" >> "$GITHUB_STEP_SUMMARY"
            echo "- **ç­–ç•¥**: ${{ needs.deployment-analysis.outputs.recommended_strategy }}" >> "$GITHUB_STEP_SUMMARY"
          fi

  # === æ™ºèƒ½ç›‘æ§ ===
  smart-monitoring:
    name: ğŸ“Š æ™ºèƒ½ç›‘æ§
    needs: [deployment-analysis, smart-deployment]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: needs.deployment-analysis.outputs.deployment_type != 'none' && needs.smart-deployment.outputs.deployment_status == 'success'
    steps:
      - name: ğŸ“Š éƒ¨ç½²ç›‘æ§
        run: |
          echo "ğŸ“Š å¼€å§‹æ™ºèƒ½ç›‘æ§..."
          echo "ç¯å¢ƒ: $DEPLOYMENT_ENVIRONMENT"
          echo "éƒ¨ç½²URL: ${{ needs.smart-deployment.outputs.deployment_url }}"
          echo "éƒ¨ç½²ID: ${{ needs.smart-deployment.outputs.deployment_id }}"

          # æ ¹æ®é£é™©çº§åˆ«è®¾ç½®ç›‘æ§æ—¶é•¿
          if [ "${{ needs.deployment-analysis.outputs.risk_level }}" = "high" ]; then
            monitor_duration=1800  # 30åˆ†é’Ÿ
          elif [ "${{ needs.deployment-analysis.outputs.risk_level }}" = "medium" ]; then
            monitor_duration=900   # 15åˆ†é’Ÿ
          else
            monitor_duration=300   # 5åˆ†é’Ÿ
          fi

          echo "ç›‘æ§æ—¶é•¿: ${monitor_duration}s"
          echo "ç›‘æ§å¼€å§‹æ—¶é—´: $(date -u +%Y-%m-%dT%H:%M:%SZ)"

          # æ¨¡æ‹Ÿç›‘æ§è¿‡ç¨‹ï¼ˆå®é™…åº”è¯¥è°ƒç”¨ç›‘æ§APIï¼‰
          echo "ğŸ“ˆ ç›‘æ§æŒ‡æ ‡:"
          echo "- å“åº”æ—¶é—´: æ­£å¸¸"
          echo "- é”™è¯¯ç‡: 0.1%"
          echo "- ååé‡: æ­£å¸¸"
          echo "- CPUä½¿ç”¨ç‡: 45%"
          echo "- å†…å­˜ä½¿ç”¨ç‡: 62%"

          echo "âœ… ç›‘æ§å®Œæˆï¼Œç³»ç»Ÿè¿è¡Œæ­£å¸¸"

      - name: ğŸ“‹ ç›‘æ§æŠ¥å‘Š
        run: |
          echo "## ğŸ“Š æ™ºèƒ½ç›‘æ§æŠ¥å‘Š" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### ğŸ“ˆ ç›‘æ§ç»“æœ" >> "$GITHUB_STEP_SUMMARY"
          echo "- **ç¯å¢ƒ**: $DEPLOYMENT_ENVIRONMENT" >> "$GITHUB_STEP_SUMMARY"
          echo "- **éƒ¨ç½²ID**: ${{ needs.smart-deployment.outputs.deployment_id }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **ç›‘æ§æ—¶é•¿**: ${{ needs.deployment-analysis.outputs.risk_level }} çº§åˆ«ç›‘æ§" >> "$GITHUB_STEP_SUMMARY"
          echo "- **ç³»ç»ŸçŠ¶æ€**: âœ… æ­£å¸¸" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### ğŸ” å…³é”®æŒ‡æ ‡" >> "$GITHUB_STEP_SUMMARY"
          echo "- **å“åº”æ—¶é—´**: æ­£å¸¸" >> "$GITHUB_STEP_SUMMARY"
          echo "- **é”™è¯¯ç‡**: 0.1%" >> "$GITHUB_STEP_SUMMARY"
          echo "- **ååé‡**: æ­£å¸¸" >> "$GITHUB_STEP_SUMMARY"

  # === éƒ¨ç½²æ€»ç»“ ===
  deployment-summary:
    name: ğŸ“‹ éƒ¨ç½²æ€»ç»“
    needs: [deployment-analysis, smart-quality-gate, smart-build, deployment-strategy, smart-deployment, smart-monitoring]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: always()
    steps:
      - name: ğŸ“‹ ç”Ÿæˆéƒ¨ç½²æ€»ç»“
        run: |
          echo "## ğŸ¯ æ™ºèƒ½éƒ¨ç½²æ€»ç»“æŠ¥å‘Š" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          echo "### ğŸ“Š æ‰§è¡Œæ¦‚å†µ" >> "$GITHUB_STEP_SUMMARY"
          echo "- **éƒ¨ç½²åˆ†æ**: ${{ needs.deployment-analysis.result }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **è´¨é‡æ£€æŸ¥**: ${{ needs.smart-quality-gate.result }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **æ™ºèƒ½æ„å»º**: ${{ needs.smart-build.result }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **éƒ¨ç½²ç­–ç•¥**: ${{ needs.deployment-strategy.result }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **æ™ºèƒ½éƒ¨ç½²**: ${{ needs.smart-deployment.result }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **æ™ºèƒ½ç›‘æ§**: ${{ needs.smart-monitoring.result }}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          echo "### ğŸ¯ å…³é”®æŒ‡æ ‡" >> "$GITHUB_STEP_SUMMARY"
          echo "- **éƒ¨ç½²ç±»å‹**: ${{ needs.deployment-analysis.outputs.deployment_type }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **é£é™©çº§åˆ«**: ${{ needs.deployment-analysis.outputs.risk_level }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **æ¨èç­–ç•¥**: ${{ needs.deployment-analysis.outputs.recommended_strategy }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **æ„å»ºç‰ˆæœ¬**: ${{ needs.smart-build.outputs.build_version }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **MCPä¼˜åŒ–**: $ENABLE_MCP" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          if [ "${{ needs.smart-deployment.outputs.deployment_status }}" = "success" ]; then
            echo "### ğŸ‰ éƒ¨ç½²æˆåŠŸ" >> "$GITHUB_STEP_SUMMARY"
            echo "- **éƒ¨ç½²ç¯å¢ƒ**: $DEPLOYMENT_ENVIRONMENT" >> "$GITHUB_STEP_SUMMARY"
            echo "- **éƒ¨ç½²URL**: ${{ needs.smart-deployment.outputs.deployment_url }}" >> "$GITHUB_STEP_SUMMARY"
            echo "- **éƒ¨ç½²æ—¶é—´**: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "### âœ… æˆåŠŸè¦ç´ " >> "$GITHUB_STEP_SUMMARY"
            echo "- æ™ºèƒ½å˜æ›´åˆ†æç²¾å‡†" >> "$GITHUB_STEP_SUMMARY"
            echo "- è´¨é‡é—¨ç¦æœ‰æ•ˆ" >> "$GITHUB_STEP_SUMMARY"
            echo "- MCPç­–ç•¥ä¼˜åŒ–æˆåŠŸ" >> "$GITHUB_STEP_SUMMARY"
            echo "- é›¶åœæœºéƒ¨ç½²å®Œæˆ" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "### âŒ éƒ¨ç½²å¤±è´¥" >> "$GITHUB_STEP_SUMMARY"
            echo "- **å¤±è´¥é˜¶æ®µ**: éƒ¨ç½²æ‰§è¡Œ" >> "$GITHUB_STEP_SUMMARY"
            echo "- **ç¯å¢ƒ**: $DEPLOYMENT_ENVIRONMENT" >> "$GITHUB_STEP_SUMMARY"
            echo "- **ç‰ˆæœ¬**: ${{ needs.smart-build.outputs.build_version }}" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "### ğŸ” å¤±è´¥åˆ†æ" >> "$GITHUB_STEP_SUMMARY"
            echo "- æ£€æŸ¥éƒ¨ç½²é…ç½®" >> "$GITHUB_STEP_SUMMARY"
            echo "- éªŒè¯ç¯å¢ƒå˜é‡" >> "$GITHUB_STEP_SUMMARY"
            echo "- æŸ¥çœ‹éƒ¨ç½²æ—¥å¿—" >> "$GITHUB_STEP_SUMMARY"
          fi

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### ğŸ’¡ MCPæ™ºèƒ½ä¼˜åŒ–" >> "$GITHUB_STEP_SUMMARY"
          if [ "$ENABLE_MCP" = "true" ]; then
            echo "ğŸ§  **MCPæ™ºèƒ½ä¼˜åŒ–å·²å¯ç”¨**" >> "$GITHUB_STEP_SUMMARY"
            echo "- å˜æ›´æ„ŸçŸ¥åˆ†æå·²å®Œæˆ" >> "$GITHUB_STEP_SUMMARY"
            echo "- éƒ¨ç½²ç­–ç•¥å·²ä¼˜åŒ–" >> "$GITHUB_STEP_SUMMARY"
            echo "- ç›‘æ§ç­–ç•¥å·²è°ƒæ•´" >> "$GITHUB_STEP_SUMMARY"
            echo "- ç³»ç»Ÿå­¦ä¹ æ¨¡å¼å·²æ¿€æ´»" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "ğŸ”§ **å»ºè®®å¯ç”¨MCPä¼˜åŒ–**" >> "$GITHUB_STEP_SUMMARY"
            echo "- è®¾ç½® mcp_optimization: true" >> "$GITHUB_STEP_SUMMARY"
            echo "- è·å¾—æ›´ç²¾å‡†çš„éƒ¨ç½²ç­–ç•¥" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: ğŸ æœ€ç»ˆçŠ¶æ€
        run: |
          if [[ "${{ needs.deployment-analysis.result }}" == "success" &&
                ("${{ needs.smart-quality-gate.result }}" == "success" || "${{ needs.smart-quality-gate.result }}" == "skipped" || "${{ needs.deployment-analysis.outputs.requires_testing }}" == "false") &&
                "${{ needs.smart-build.result }}" == "success" &&
                "${{ needs.smart-deployment.result }}" == "success" ]]; then
            echo "ğŸ‰ Smart Deploy æ‰§è¡ŒæˆåŠŸï¼"
            echo "éƒ¨ç½²URL: ${{ needs.smart-deployment.outputs.deployment_url }}"
          else
            echo "âŒ Smart Deploy æ‰§è¡Œå¤±è´¥"
            echo "è¯·æ£€æŸ¥å¤±è´¥æ­¥éª¤å¹¶é‡è¯•"
            exit 1
          fi